#!/usr/bin/env bash
set -e

cd "$(dirname "$0")/.."

# Create config dir if not present
if [[ ! -d "${PWD}/config" ]]; then
    mkdir -p "${PWD}/config"
    /home/vscode/.local/ha-venv/bin/python -m homeassistant --config "${PWD}/config" --script ensure_config
fi

# Ensure custom components dir exists
mkdir -p "${PWD}/config/custom_components"

# Link the ocpp integration (overwrite if exists)
ln -sfn "${PWD}/custom_components/ocpp" "${PWD}/config/custom_components/ocpp"

# Install debugpy if missing
/home/vscode/.local/ha-venv/bin/python -m pip install --quiet debugpy || true

# Start Home Assistant with debugger
exec /home/vscode/.local/ha-venv/bin/python -m debugpy --listen 0.0.0.0:5678 \
    -m homeassistant --config "${PWD}/config" --debug
